<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Car Rental</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        background-color: #f8f9fa;
      }
      .car-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
      }
      footer {
        background-color: #343a40;
        color: white;
        padding: 20px 0;
        text-align: center;
        margin-top: 40px;
      }
    </style>
  </head>

  <body class="d-flex flex-column min-vh-100">

    <!-- Navbar -->
    <!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Car Rental</a>
  
      <!-- 自动收起按钮（小屏用） -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
  
      <!-- 右侧内容 -->
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item me-2">
            <a class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal">
                Login
              </a>              
          </li>
          <li class="nav-item">
            <a class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#registerModal">
                Register
              </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  
    <!-- Main content -->
    <div class="container-fluid flex-grow-1 py-4">
      <h3 class="mb-4 text-center">Available Cars</h3>
  
      {% for car in car_list %}
        <div class="car-card mx-auto" style="max-width: 700px;">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ car.make }} {{ car.model }}</h5>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#carModal{{ car.id }}">
              View Details
            </button>
          </div>
        </div>
  
        <!-- Modal -->
        <div class="modal fade" id="carModal{{ car.id }}" tabindex="-1" aria-labelledby="carModalLabel{{ car.id }}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="carModalLabel{{ car.id }}">Car Details</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p><strong>Make:</strong> {{ car.make }}</p>
                  <p><strong>Model:</strong> {{ car.model }}</p>
                  <p><strong>Year:</strong> {{ car.year }}</p>
                  <p><strong>Mileage:</strong> {{ car.mileage }} km</p>
                  <p><strong>Available:</strong> {{ car.available_now|yesno:"Yes,No" }}</p>
                  <p><strong>Daily Rental Price:</strong> ${{ car.daily_rental_price }}</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="handleBooking({{ car.id }},{{car.daily_rental_price}})">
                        Book Now
                      </button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
      {% empty %}
        <p class="text-muted text-center">No cars available at the moment.</p>
      {% endfor %}
    </div>
  
    <!-- Footer -->
    <footer class="bg-dark text-white text-center py-3 mt-auto">
      &copy; {{ now|date:"Y" }} Car Rental System. All rights reserved.
    </footer>
  <!-- Login Modal -->
<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-sm border-0" style="border-radius: 12px;">
        <div class="modal-header bg-white border-0">
          <h5 class="modal-title" id="loginModalLabel">Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body px-4">
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" id="username" class="form-control rounded-pill px-3 py-2" />
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="password" class="form-control rounded-pill px-3 py-2" />
          </div>
          <div id="login-error" class="alert alert-danger d-none">
            Login failed. Please check your credentials or <a href="#" class="text-primary text-decoration-underline" data-bs-toggle="modal" data-bs-target="#registerModal">
                Register here
              </a>
          </div>
          <button id="login-btn" class="btn btn-primary w-100 rounded-pill">Login</button>
        </div>
  
        <div class="modal-footer justify-content-center border-0 bg-light">
          Don't have an account? <a href="#" class="text-primary text-decoration-underline" data-bs-toggle="modal" data-bs-target="#registerModal">
            Register
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
<div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-sm border-0" style="border-radius: 12px;">
        <div class="modal-header bg-white border-0">
          <h5 class="modal-title" id="registerModalLabel">Register</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body px-4">
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" id="reg-username" class="form-control" />
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="reg-email" class="form-control" />
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="reg-password" class="form-control" />
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select id="reg-role" class="form-select">
              <option value="Customer" selected>Customer</option>
            </select>
          </div>
  
          <div id="register-error" class="alert alert-danger d-none"></div>
  
          <button id="register-btn" class="btn btn-primary w-100">Register</button>
        </div>
  
        <div class="modal-footer justify-content-center border-0 bg-light">
          <p class="mb-0">Already have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">Login here</a></p>
        </div>
      </div>
    </div>
  </div>  
  <!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="bookingModalLabel">Book This Car</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body">
          <input type="hidden" id="bookingCarId" />
          <div class="mb-3">
            <label for="startDate" class="form-label">Start Date</label>
            <input type="date" class="form-control" id="startDate" required />
          </div>
          <div class="mb-3">
            <label for="endDate" class="form-label">End Date</label>
            <input type="date" class="form-control" id="endDate" required />
          </div>
  
          <div class="alert alert-info d-none" id="bookingPriceInfo"></div>
          <!-- 价格显示区域 -->
        <div class="alert alert-light border" id="bookingPriceInfo">
            <p class="mb-1" id="dailyRateText"></p>
            <p class="mb-1" id="rentalPeriodText"></p>
            <strong id="totalPriceText"></strong>
        </div>
  
  
          <button class="btn btn-primary w-100" onclick="submitBooking()">Confirm Booking</button>
        </div>
      </div>
    </div>
  </div>
  
  </body>
  
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        //login
        document.getElementById("login-btn").addEventListener("click", async () => {
          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value.trim();
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
          const loginUrl = "{% url 'login' %}";
          console.log(loginUrl)
          const response = await fetch(loginUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({ username, password })
          });
      
          const data = await response.json();
      
          if (response.ok && data.success) {
            // 登录成功，刷新页面或跳转
            window.location.reload();
          } else {
            // 显示错误提示
            document.getElementById("login-error").classList.remove("d-none");
          }
        });
        //register
        document.getElementById('register-btn').addEventListener('click', async () => {
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value.trim();
  const role = document.getElementById('reg-role').value;
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
  const errorDiv = document.getElementById("register-error");

  // ✅ 清空错误提示
  errorDiv.classList.add("d-none");
  errorDiv.textContent = "";

  // ✅ 前端验证
  if (username.length < 3) {
    errorDiv.textContent = "Username must be at least 3 characters.";
    errorDiv.classList.remove("d-none");
    return;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    errorDiv.textContent = "Please enter a valid email address.";
    errorDiv.classList.remove("d-none");
    return;
  }

  if (password.length < 6) {
    errorDiv.textContent = "Password must be at least 6 characters.";
    errorDiv.classList.remove("d-none");
    return;
  }

  // ✅ 通过验证，发送请求
  const res = await fetch("{% url 'register' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken
    },
    body: JSON.stringify({ username, email, password, role })
  });

  const data = await res.json();

  if (data.success) {
    alert("Registration successful!");
    window.location.reload();
  } else {
    errorDiv.textContent = data.error || "Registration failed.";
    errorDiv.classList.remove("d-none");
  }
});

//booking
async function handleBooking(carId,dailyPrice) {
    try {
      const res = await fetch("{% url 'checkAuth' %}");
      const data = await res.json();
      const carModal = bootstrap.Modal.getInstance(document.querySelector(`#carModal${carId}`));
        carModal.hide();
      if (data.is_authenticated) {
        // ✅ 已登录，跳转或打开 booking 流程
        openBookingModal(carId,dailyPrice)
      } else {
        // ❌ 未登录，先关闭 carModal
       

        // ✨ 简单提示用户登录（可改成 toast）
        setTimeout(() => {
          alert("Please login to continue booking.");

          // 然后显示登录模态框
          const loginModal = new bootstrap.Modal(document.getElementById("loginModal"));
          loginModal.show();
        }, 300); // 稍作延迟以避免动画冲突
      }
    } catch (error) {
      console.error("Login check failed", error);
      alert("Something went wrong. Please try again.");
    }
  }

  function openBookingModal(carId, dailyPrice) {
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 0);

  const todayStr = today.toISOString().split("T")[0];
  const tomorrowStr = tomorrow.toISOString().split("T")[0];

  // 设置日期值和限制
  const startInput = document.getElementById("startDate");
  const endInput = document.getElementById("endDate");

  startInput.min = todayStr;
  startInput.value = todayStr;

  endInput.min = todayStr;
  endInput.value = tomorrowStr;

  // 存储 car id 和价格
  document.getElementById("bookingCarId").value = carId;
  document.getElementById("bookingModal").dataset.dailyPrice = dailyPrice;

  // 设置监听器
  startInput.onchange = calculatePrice;
  endInput.onchange = calculatePrice;

  // ✅ 初次加载时立即计算价格
  calculatePrice();

  // 打开模态框
  const modal = new bootstrap.Modal(document.getElementById("bookingModal"));
  modal.show();
}


  function calculatePrice() {
  const startInput = document.getElementById("startDate").value;
  const endInput = document.getElementById("endDate").value;

  const start = new Date(startInput);
  const end = new Date(endInput);
  const pricePerDay = parseFloat(document.getElementById("bookingModal").dataset.dailyPrice);

  const dailyRateText = document.getElementById("dailyRateText");
  const rentalPeriodText = document.getElementById("rentalPeriodText");
  const totalPriceText = document.getElementById("totalPriceText");

  if (end >= start) {
    const days = (end - start) / (1000 * 60 * 60 * 24) + 1;
    const total = (days * pricePerDay).toFixed(2);

    dailyRateText.textContent = `Daily Price: $${pricePerDay.toFixed(2)}`;
    rentalPeriodText.textContent = `Rental Period: ${startInput} to ${endInput}`;
    totalPriceText.textContent = `Total Price: $${total} (${days} days)`;
  } else {
    dailyRateText.textContent = '';
    rentalPeriodText.textContent = '';
    totalPriceText.textContent = '';
  }
}


  async function submitBooking() {
    const carId = document.getElementById("bookingCarId").value;
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    const res = await fetch(`/book/${carId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")?.value,
      },
      body: JSON.stringify({ start_date: startDate, end_date: endDate }),
    });

    const data = await res.json();
    if (data.success) {
      alert("Booking confirmed!");
      window.location.reload();
    } else {
      alert("Booking failed: " + (data.error || "Unknown error."));
    }
  }
</script>
      
</html>
